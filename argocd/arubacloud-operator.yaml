# ArubaCloud Operator
# This deploys the ArubaCloud Operator which manages ArubaCloud resources
# It authenticates to Vault using AppRole to retrieve tenant credentials
# Prerequisites: Vault must be configured with AppRole (see vault-config application)

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: arubacloud-operator
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "10"  # Deploy after vault (wave 1) and vault-config (wave 5)
spec:
  project: platform
  
  source:
    repoURL: https://arubacloud.github.io/helm-charts
    chart: arubacloud-operator
    targetRevision: 0.32.0
    helm:
      values: |
        config:
          auth:
            mode: multi
            multi:
              vault:
                address: http://vault.vault.svc:8200
                kvMount: kv
                rolePath: approle
                # TODO: Choose ONE of the following approaches based on your Helm chart:
                
                # Approach 1: If chart supports secretKeyRef (RECOMMENDED)
                # roleIdFrom:
                #   secretKeyRef:
                #     name: vault-approle-credentials
                #     key: role-id
                # roleSecretFrom:
                #   secretKeyRef:
                #     name: vault-approle-credentials
                #     key: secret-id
                
                # Approach 2: If chart only accepts string values (you'll need to update manually once)
                roleId: "REPLACE_WITH_ACTUAL_VALUE"  # Get from: kubectl get secret vault-approle-credentials -n aruba-system -o jsonpath='{.data.role-id}' | base64 -d
                roleSecret: "REPLACE_WITH_ACTUAL_VALUE"  # Get from: kubectl get secret vault-approle-credentials -n aruba-system -o jsonpath='{.data.secret-id}' | base64 -d
        
        # Approach 3: If chart supports environment variable injection
        # env:
        # - name: VAULT_ROLE_ID
        #   valueFrom:
        #     secretKeyRef:
        #       name: vault-approle-credentials
        #       key: role-id
        # - name: VAULT_SECRET_ID
        #   valueFrom:
        #     secretKeyRef:
        #       name: vault-approle-credentials
        #       key: secret-id
  destination:
    server: https://kubernetes.default.svc
    namespace: aruba-system
    
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m


